<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV</title>
</head>
<body>
    <h1>Alle CVs</h1>
    <h3 id="login-greeting">welkom anonieme gebruiker</h3>
    <h3 id="no_access">alleen trainees en accountmanagers mogen cv's bekijken</h3>
    <div id="content" hidden>
        <table>
            <thead>
                <tr>
                    <th>id</th>
                    <th>omschrijving</th>
                    <th>werkhistorie</th>
                    <th>uitstroom</th>
                    <th>specialisatie</th>
                    <th>person id</th>
                    <th>update</th>
                    <th>delete</th>
                </tr>
            </thead>
            <tbody id="cv-table"></tbody>
        </table>
    
        <input type="text" id="omschrijving">
        <input type="text" id="werkHistorie">
        <input type="text" id="uitstroomRichting">
        <input type="text" id="specialiteit">
        <input type="number" id="personId">
        <button type="button" onclick="saveCV()">Save</button>
    </div>

    <script>
        function getCVs(){
            fetch('http://localhost:8080/curriculum_vitae/all')
                .then(response => response.json())
                .then(data => reloadTable(data));
        }

        function reloadTable(data){
            let artistTable = document.getElementById('cv-table');
            artistTable.innerHTML = "";

            data.forEach(cv => {
                artistTable.innerHTML += `
                <tr>
                    <td>${cv.id}</td>
                    <td><input type="text" id="omschrijving${cv.id}" value=${cv.omschrijving}></td>
                    <td><input type="text" id="werkHistorie${cv.id}" value=${cv.werkHistorie}></td>
                    <td><input type="text" id="uitstroomRichting${cv.id}" value=${cv.uitstroomRichting}></td>
                    <td><input type="text" id="specialiteit${cv.id}" value=${cv.specialiteit}></td>
                    <td><input type="text" id="personId${cv.id}" value=${cv.personId}></td>
                    <td><button type="button" onclick="update(${cv.id})">update</button></td>
                    <td><button type="button" onclick="delete_cv(${cv.id})">delete</button></td>
                </tr>
                `
            });
        }

        function update(id){
            let updatedCV = {
                omschrijving:document.getElementById(`omschrijving${id}`).value,
                werkHistorie:document.getElementById(`werkHistorie${id}`).value,
                uitstroomRichting:document.getElementById(`uitstroomRichting${id}`).value,
                specialiteit:document.getElementById(`specialiteit${id}`).value,
                personId:document.getElementById(`personId${id}`).value
            };
            fetch(`http://localhost:8080/curriculum_vitae/update?id=${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedCV)})
            .then(response => getCVs());
        }

        function delete_cv(id){
            fetch(`http://localhost:8080/curriculum_vitae/remove?id=${id}`, {method: 'DELETE'})
            .then(response => getCVs());
        }

        function saveCV(){
            let newCV = {
                omschrijving:document.getElementById('omschrijving').value,
                werkHistorie:document.getElementById('werkHistorie').value,
                uitstroomRichting:document.getElementById('uitstroomRichting').value,
                specialiteit:document.getElementById('specialiteit').value,
                personId:document.getElementById('personId').value
            };

            fetch(`http://localhost:8080/curriculum_vitae/add`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newCV)})
            .then(response => getCVs());
        }

        function checkLogin(){
            if(sessionStorage.userID){
                fetch(`http://localhost:8080/account/${sessionStorage.userID}`, {
                    method:'GET'
                })
                .then(response => response.json())
                .then(data => setName(data));
            }
        }

        function setName(account){
            greetingspot = document.getElementById('login-greeting');
            greetingspot.innerHTML = `Welkom ${account.naam}`;
            if(account.rol == 'trainee' || account.rol == 'accountmanager'){
                document.getElementById('content').hidden = false;
                document.getElementById('no_access').hidden = true;
            }
        }

        checkLogin();
        getCVs();
    </script>
</body>
</html>